# Kaush's tmux configuration
# https://kau.sh

# reload tmux configuration (overrides default `r` binding; shows a confirmation message)
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Reloaded tmux.conf"

# switch prefix key from Ctrl B → Ctrl A
# Disable tmux's default prefix (C-b).
unbind C-b
set -g prefix C-a
# With prefix set to C-a, allow C-a C-a to send a literal C-a to the program.
bind C-a send-prefix


set-window-option -g mode-keys vi

# Use fish as the default login shell for new windows (leave default-command empty).
set -g default-shell    /opt/homebrew/bin/fish

# Setting this to 0 can make tmux feel more responsive, but may break Alt/Meta keybindings in some terminals.
# set-option -sg escape-time 0
set-option -g history-limit 5000
set-option -g repeat-time 1200   # longer window for repeatable (-r) bindings (default: 500ms)

# Notify when background work produces output (activity) or explicitly rings a bell.
# - Activity covers builds/tests that print output in another window.
# - Bell covers commands that end with `printf '\a'` (or similar).
set-window-option -g monitor-activity on
# Enable bell monitoring so `visual-bell`/`bell-action` settings apply.
set-window-option -g monitor-bell on
set-option -g visual-activity on
set-option -g activity-action other

set-option -g visual-bell on
set-option -g bell-action other

# Keep tmux alerts/messages visible slightly longer (milliseconds).
set-option -g display-time 1000

# automatically rename tmux-window to current path
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# interpret mouse gestures properly
# Enable mouse for resizing/selecting panes (this single setting is enough).
set -g mouse on
# bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"


# ------------------------------------
# Theme (swap this path to change themes)
source-file ~/.config/tmux/theme.conf

set-window-option -g window-status-separator '  '
set-window-option -g window-status-activity-style 'underscore'
set-window-option -g window-status-bell-style 'underscore'

# True color (24-bit RGB) support
set -g default-terminal "tmux-256color"
set -g terminal-features "xterm*:clipboard:ccolour:cstyle:focus:title,screen*:title,rxvt*:ignorefkeys,ghostty:RGB,xterm-ghostty:RGB,xterm-256color:RGB"

set-option -g status-right-length 80
set-option -g status-left-length 60

# move status bar to top
set-option -g status-position top

# ------------------------------------
# rebinding common commands

# Split new panes in the current pane's working directory (| = vertical, - = horizontal).
bind | split-window -h -c "#{pane_current_path}"
bind V split-window -h -c "#{pane_current_path}"      # alias for |
bind - split-window -v -c "#{pane_current_path}"
bind S split-window -v -c "#{pane_current_path}"      # alias for -
unbind '"'                                             # replace default horizontal split
unbind %                                               # replace default vertical split

# Make resize bindings repeatable (press prefix once, then hold the key).
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# kill pane/window without confirmation
bind x kill-pane
bind & kill-window

# cycle windows (n/p) and sessions (N/P) — repeatable
bind -r n next-window
bind -r p previous-window
bind -r N switch-client -n
bind -r P switch-client -p

# choose-tree with dimmer window names (sessions stay bright)
# note: tree prefix (-> + 0:) is rendered by tmux separately, color only affects description
bind w choose-tree -Zw -F '#{?window_format,#[fg=brightblack]#{window_name}#{window_flags}: "#{pane_title}"  #{pane_current_path},#{session_windows} windows#{?session_attached, (attached),}}'
bind -n C-s choose-tree -Zs -F '#{session_windows} windows#{?session_attached, (attached),}'  # Ctrl+S: quick session switcher (sessions only)


# ---------------------------------------------
# fzf file picker popup (Ctrl+A t)
# Ctrl+G: show gitignored files | Ctrl+H: hide gitignored files
bind t run-shell "tmux display-popup -E -w 80% -h 80% '~/bin/tmux-fzf-picker \"#{pane_current_path}\" \"#{pane_id}\"'"

# # ---------------------------------------------
# # Subagent menu (prefix + 9)
# # Spawns a background window running a chosen CLI agent.
# bind g display-menu -T "Subagent" \
#     "Spawn (codex)"  c "run-shell -b '$HOME/bin/tmux-subagent prompt-spawn \"#{pane_id}\" \"#{pane_current_path}\" codex'" \
#     "Spawn (claude)" a "run-shell -b '$HOME/bin/tmux-subagent prompt-spawn \"#{pane_id}\" \"#{pane_current_path}\" claude'" \
#     "Spawn (gemini)" g "run-shell -b '$HOME/bin/tmux-subagent prompt-spawn \"#{pane_id}\" \"#{pane_current_path}\" gemini'"
