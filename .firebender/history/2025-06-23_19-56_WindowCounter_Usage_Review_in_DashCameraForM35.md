<!-- Generated by Firebender -->

# WindowCounter Usage Review in DashCameraForM35 (2025-06-23 20:02:53)

_**User**_

Check if my usage of @WindowCounter.kt is correct in @DashCameraForM35.kt

---

Read file: common/utils/core/src/commonMain/kotlin/com/instacart/caper/common/utils/core/common/counters/WindowCounter.kt

---

_**Assistant**_

Your usage of `WindowCounter` is mostly correct, but there's a lifecycle management issue. Currently:

```kotlin
private val frameAnalyticsSampler = WindowCounter { count ->
  Log.debug(TAG, "[DCS][DC] $count frames received from camera")
}
```

This uses the default `CoroutineScope(Dispatchers.IO)` which is independent of your `cameraScope`. This means the WindowCounter's internal job could continue running even after `DashCameraForM35.close()` is called.

---

Code edit

---

Terminal: terminal command

---

_**Assistant**_

Fixed. The WindowCounter now uses the same `cameraScope` for proper lifecycle management. When `close()` is called, both the frame collection job and the WindowCounter's internal job will be cancelled together through `cameraScope.coroutineContext.cancelChildren()`.

**Test result:** âœ… Compilation successful

ðŸŽµ **Notification:** Your request has been completed. The WindowCounter usage in DashCameraForM35 has been corrected to use the proper coroutine scope for lifecycle management.

---

_**User**_

won't frameAnalyticsSampler.close() cause a problem since it's internally canceling the camerascope?

---

Read file: common/utils/core/src/commonMain/kotlin/com/instacart/caper/common/utils/core/common/counters/WindowCounter.kt

---

_**Assistant**_

You're right to be concerned. `WindowCounter.close()` only cancels its internal `job`, not the entire scope. However, there's still a redundancy issue.

Since we're passing `cameraScope` to WindowCounter, when we call `cameraScope.coroutineContext.cancelChildren()`, it will already cancel the WindowCounter's job. The explicit `frameAnalyticsSampler.close()` call becomes redundant and could potentially cause a double-cancellation scenario.

```34:40:feature/dashcam/impl/src/main/java/ai/caper/camera2/DashCameraForM35.kt
// ... existing code ...
  override fun close() {
    frameCollectionJob?.cancel()
    cameraScope.coroutineContext.cancelChildren()
    basketCamera.close()
    frameCallback = null
  }
// ... existing code ...
```

The `frameAnalyticsSampler.close()` call should be removed since `cancelChildren()` will handle it automatically.

---

_**User**_

/Users/kg/src/off/caper/caper-repo/caper/cart/capercore/common/utils/core/src/commonTest/kotlin/com/instacart/caper/common/utils/core/common/counters/WindowCounterTest.kt:149:17: RuntimeException is a too generic Exception. Prefer throwing specific exceptions that indicate a specific error case. [TooGenericExceptionThrown]

---

Read file: common/utils/core/src/commonTest/kotlin/com/instacart/caper/common/utils/core/common/counters/WindowCounterTest.kt

---

Code edit

---

_**User**_

suppress UseCheckOrError for this

---

Code edit

---

Terminal: terminal command

---

_**Assistant**_

Fixed. Added `@Suppress("UseCheckOrError")` annotation to suppress the linting warning for the test exception.

**Test result:** âœ… All 11 WindowCounter tests passed

ðŸŽµ **Notification:** Your request has been completed. The UseCheckOrError warning has been suppressed for the test exception and all tests are passing.

